# Generated by cmd/sidecar-tasks/main.go; DO NOT EDIT.
apiVersion: tekton.dev/v1beta1
kind: '{{default "ClusterTask" .Values.taskKind}}'
metadata:
  creationTimestamp: null
  name: '{{default "ods" .Values.taskPrefix}}-build-typescript-with-sidecar{{.Values.taskSuffix}}'
spec:
  description: "Builds Typescript applications.\n\nThe following steps are executed:\n\n-
    checks that package.json and package-lock.json exists to require best practice
    of using lock files. See also https://github.com/opendevstack/ods-pipeline/discussions/411
    \n- linting using `eslint`\n- build typescript application, using `npm run build`\n-
    test execution\n- SonarQube quality scan\n\nFor `eslint` to work there needs to
    be a config file (`eslintrc.json` or similar) at the root of the working directory.\nThis
    can be done by running `eslint --init` or by following the link:https://eslint.org/docs/user-guide/getting-started[official
    documentation]\n\nThe exact build recipe can be found at\nlink:https://github.com/opendevstack/ods-pipeline/blob/master/build/package/scripts/build-typescript.sh[build/package/scripts/build-typescript.sh].\nIn
    particular, `npm run build` is expected to place outputs into `dist`.\n\nAfter
    tests ran successfully, the application source code is scanned by SonarQube.\nDefault
    SonarQube project properties are provided unless `sonar-project.properties`\nis
    present.\nWhen `sonar-quality-gate` is set to `true`, the task will fail if the
    quality gate\nis not passed. If SonarQube is not desired, it can be disabled via
    `sonar-skip`.\nThe SonarQube scan will include parameters to perform a pull request
    analysis if\nthere is an open pull request for the branch being built. If the\nlink:https://docs.sonarqube.org/latest/analysis/bitbucket-integration/[ALM
    integration]\nis setup properly, pull request decoration in Bitbucket is done
    automatically.\n\nThe following artifacts are generated by the build task and
    placed into `.ods/artifacts/`\n\n* `code-coverage/`\n  ** `clover.xml`\n  ** `coverage-final.json`\n
    \ ** `lcov.info`\n* `lint-reports`\n  ** `report.txt`\n* `sonarqube-analysis/`\n
    \ ** `analysis-report.md`\n  ** `issues-report.csv`\n  ** `quality-gate.json`\n*
    `xunit-reports/`\n  ** `report.xml`\n\n**Sidecar variant!** Use this task if you
    need to run a container next to the build task.\nFor example, this could be used
    to run a database to allow for integration tests.\nThe sidecar image to must be
    supplied via `sidecar-image`.\nApart from the sidecar, the task is an exact copy
    of `ods-build-typescript`."
  params:
  - default: .
    description: |
      Working directory. The path must be relative to the root of the repository,
      without leading `./` and trailing `/`.
    name: working-dir
    type: string
  - default: docker
    description: Path to the directory into which outputs should be placed, relative
      to `working-dir`. This directory may then later be used as Docker context for
      example.
    name: output-dir
    type: string
  - default: "0"
    description: Maximum of allowed linting warnings after which eslint will exit
      with an error. Set to "-1" to never exit with an error due to warnings.
    name: max-lint-warnings
    type: string
  - default: .js,.ts,.jsx,.tsx,.svelte
    description: File extensions to lint separated by a comma.
    name: lint-file-ext
    type: string
  - default: "false"
    description: Whether quality gate needs to pass.
    name: sonar-quality-gate
    type: string
  - default: "false"
    description: Whether to skip the SonarQube analysis or not.
    name: sonar-skip
    type: string
  - default: "16"
    description: 'Node.js version to use - supported versions: 16'
    name: node-version
    type: string
  - default: dist
    description: Must match the directory into which `npm run build` places files.
      The files inside `build-dir` will be copied to the `dist` folder in `output-dir`
      As a result the files will be in `$output-dir/dist` Other common build directories
      are `build` and `public`.
    name: build-dir
    type: string
  - default: "false"
    description: Whether `node-modules` is copied to the `output-dir` or not. If copied
      the node modules are in `$output-dir/dist/node_modules`.  For frontend components
      this should be set to "false", while for backend components this should be set
      to "true".
    name: copy-node-modules
    type: string
  - description: Image to use for sidecar
    name: sidecar-image
    type: string
  sidecars:
  - Workspaces: null
    image: $(params.sidecar-image)
    name: sidecar
    resources: {}
  steps:
  - env:
    - name: HOME
      value: /tekton/home
    - name: CI
      value: "true"
    - name: NEXUS_URL
      valueFrom:
        configMapKeyRef:
          key: url
          name: ods-nexus
    - name: NEXUS_USERNAME
      valueFrom:
        secretKeyRef:
          key: username
          name: ods-nexus-auth
    - name: NEXUS_PASSWORD
      valueFrom:
        secretKeyRef:
          key: password
          name: ods-nexus-auth
    - name: DEBUG
      valueFrom:
        configMapKeyRef:
          key: debug
          name: ods-pipeline
    image: '{{.Values.registry}}/{{.Values.namespace}}/ods-node$(params.node-version)-typescript-toolset:{{.Values.imageTag}}'
    name: build-typescript
    resources: {}
    script: |2

      # build-typescript is build/package/scripts/build-typescript.sh.
      build-typescript \
        --working-dir=$(params.working-dir) \
        --output-dir=$(params.output-dir) \
        --debug=${DEBUG} \
        --max-lint-warnings=$(params.max-lint-warnings) \
        --lint-file-ext=$(params.lint-file-ext) \
        --build-dir=$(params.build-dir) \
        --copy-node-modules=$(params.copy-node-modules)
    workingDir: $(workspaces.source.path)
  - env:
    - name: HOME
      value: /tekton/home
    - name: SONAR_URL
      valueFrom:
        configMapKeyRef:
          key: url
          name: ods-sonar
    - name: SONAR_EDITION
      valueFrom:
        configMapKeyRef:
          key: edition
          name: ods-sonar
    - name: SONAR_AUTH_TOKEN
      valueFrom:
        secretKeyRef:
          key: password
          name: ods-sonar-auth
    - name: DEBUG
      valueFrom:
        configMapKeyRef:
          key: debug
          name: ods-pipeline
    image: '{{.Values.registry}}/{{.Values.namespace}}/ods-sonar:{{.Values.imageTag}}'
    name: scan-with-sonar
    resources: {}
    script: |
      if [ "$(params.sonar-skip)" = "true" ]; then
        echo "Skipping SonarQube analysis"
      else
        mkdir -p .ods/artifacts/sonarqube-analysis
        # sonar is built from cmd/sonar/main.go.
        sonar \
          -working-dir=$(params.working-dir) \
          -quality-gate=$(params.sonar-quality-gate)
      fi
    workingDir: $(workspaces.source.path)
  workspaces:
  - name: source
