= Task Requirements

== `ods-start`

[cols="1,1"]
|===
| REQ-TASK-START-1
a| The task shall check out the repository of given URL and Git ref into the mounted workspace, cleaning any previous contents. If the checked out `ods.yml` configures any child repositories, those shall be checked out as well from the configured URL and Git ref.

* All checkouts shall support shallow mode
* All checkouts shall support submodules

| REQ-TASK-START-2
a| The task shall store context information under `.ods` for each checked out repository:

* repository related information: project key, component key, repository name, Git URL, Git (full) ref, Git commit SHA, pull request base and pull request key.
* OpenShift related information: namespace
* deployment related information: version and environment

| REQ-TASK-START-3
| The task shall download all artifacts from Nexus belonging to the same commit being built and place them into the respective `.ods/artifacts` for each checked out repository.

| REQ-TASK-START-4
| The task shall set the Bitbucket build status of the commit being built to "in progress". The build status shall link back to the pipeline run.

| REQ-TASK-START-5
| The task shall fail when any child repository is missing a successful pipeline run artifact for the checked out commit.
|===

== `ods-finish`

[cols="1,1"]
|===
| REQ-TASK-FINISH-1
| The task shall set the Bitbucket build status to "failed" or "successful", depending on whether all tasks succeeded or not. The build status shall link back to the pipeline run.

| REQ-TASK-FINISH-2
| The task shall create an artifact for the pipeline run, containing its name and status, provided that all tasks succeeded.

| REQ-TASK-FINISH-3
| The task shall upload all files in any `.ods/artifacts` folder to Nexus, storing them in a group named `/<PROJECT>/<REPOSITORY>/<GIT-COMMIT-SHA>`, provided that all tasks succeeded.
|===

== `ods-build-go`

[cols="1,1"]
|===
| REQ-TASK-BUILD-GO-1
| The task shall check that all Go files are gofmt'd and fail if this is not the case.

| REQ-TASK-BUILD-GO-2
| The task shall run golanglint-ci and fail if there are any findings.

| REQ-TASK-BUILD-GO-3
a| The task shall build a Go module based Go binary into `docker/app`:

* The destination directory shall be customizable
* Paths in stack traces shall be trimmed
* The target operating system (`GOOS`) and architecture (`GOARCH`) shall be customizable
* CGO shall be disabled by default but shall be enablable by parameter.

| REQ-TASK-BUILD-GO-4
a| The task shall run `go test`, creating code coverage and xUnit report.

* All packages except vendored ones shall be tested.
* The artifacts shall be placed in the working directory (for SonarQube to pick them up) and in `.ods/artifacts`.
* If tests already ran for the commit being built, testing shall be skipped and the existing artifacts shall be copied into the working directory.

| REQ-TASK-BUILD-GO-5
a| The task shall run `sonar-scanner` on the sources, communicating with the SonarQube server specified by the `ods-sonar` config map and the `ods-sonar-auth` secret:

* The project name shall be fixed to `<PROJECT>-<COMPONENT>`
* If the server edition supports it, the branch parameter shall be set, unless the branch being built belongs to an open PR, in which case PR analysis parameter shall be sent instead.

| REQ-TASK-BUILD-GO-6
a| The task shall be able to run in a subdirectory of the checked out repository.

* Generated artifacts shall be prefixed with `<SUBDIRECTORY>-`
* The SonarQube project shall be suffixed with `-<SUBDIRECTORY>`

|===

== `ods-build-image`

[cols="1,1"]
|===
| REQ-TASK-BUILD-IMAGE-1
| The task shall build a container image based on the `Dockerfile` in the Docker context directory.

* The Docker context directory shall default to `docker` and be parameterized by `docker-dir`.
* The Dockerfile shall default to `Dockerfile`, and be parameterized by `dockerfile`. The location shall be relative to the Docker context directory.
* The resulting image name and SHA shall be placed into `.ods/artifacts`.

| REQ-TASK-BUILD-IMAGE-2
| The task shall check if an image with the tag to built exist already in the target registry, and if so, skip the build.

| REQ-TASK-BUILD-IMAGE-3
| The task shall push the image to the target registry.

| REQ-TASK-BUILD-IMAGE-4
| If the Aqua scanner is installed in the base image, the  pushed image shall be scanned. The resulting report shall be placed in `.ods/artifacts` and attached as a code insight to Bitbucket.
|===

== `ods-deploy-helm` TODO

[cols="1,1"]
|===
| REQ-TASK-DEPLOY-HELM-1
| Push images into the target namespace. The images that are pushed are determined by the artifacts in `.ods/artifacts/image-digests` (which contains information from where to get the images). TODO: define how to select the target namespace (somehow based on branch/tag/YAML).

| REQ-TASK-DEPLOY-HELM-2
| It errors if there is no chart at the location identified by the `chartDir` parameter (defaulting to `chart`).

| REQ-TASK-DEPLOY-HELM-3
| Upgrade (or install) Helm chart, showing a diff beforehand and decrypting secrets on the fly.

| REQ-TASK-DEPLOY-HELM-4 (?)
| Lint chart before applying and error if there is a failure.
|===
