# Admin Installation Guide

This guide will show how to install `ods-pipeline` in an existing ODS cluster. Note this is a one-time installation done by a cluster admin and does not need to be repeated for every project that wants to use `ods-pipeline`.

Centrally installed resources are `BuildConfig` and `ImageStream` resources to produce images required by the ODS tasks, as well as the `ClusterTask` resources themselves.

## Prerequisites

You'll need:

* A namespace in an OpenShift cluster (such as `ods`)
* `git`, `oc` and `helm` installed locally
* to be logged into OpenShift on the command line *as a cluster admin*

## Instructions

First, create a repository in Bitbucket, e.g. `ods`. The name can be anything, but since the repository will define the resources in namespace `ods` in code, it makes sense to mirror the namespace name. Clone the repository locally and make an initial commit, e.g. by adding a readme file.

Then, use `git subtree` to get the required sources. The following commands may look a bit complicated, but in a nutshell, they are simply adding one folder (`deploy/central`) from the `opendestack/ods-pipeline` repository at the given revision (`master`) into your new local repository at the path `ods-pipeline`.

```
pipelineGitRef=master
git fetch --depth=1 https://github.com/opendevstack/ods-pipeline.git $pipelineGitRef:ods-pipeline-$pipelineGitRef
git checkout ods-pipeline-$pipelineGitRef
git subtree split --squash --prefix=deploy/central -b subtree-split-branch-$pipelineGitRef
git checkout -
git subtree add --prefix=ods-pipeline subtree-split-branch-$pipelineGitRef
```

Once this is done, change to the new folder `ods-pipeline`. In there, add a `values.foo-cd.yaml` file and fill in the variables. The values expected for those variables are explained in `chart/values.yaml`. The secrets should be stored in a separate file, e.g. `secrets.foo-cd.yaml`. For this, you'll need a GPG keypair, which fingerprint needs to be recorded in `.sops.yaml`, e.g.:

```
creation_rules:
  - pgp: "A2F9 D4AF 800A 5499 3667 5C66 B92D F67B 0EF2 B057"
```

If you configure an Aqua scanner download URL, make sure that username/password are URL-encoded and that the `scannercli` version matches your Aqua server version.

Then you can install the `images` chart via `./install.sh -n ods --chart=images --values=values.ods.yaml,secrets.ods.yaml`. You may also use `--dry-run` to see the changes first. This will install `BuildConfig` and `ImageStream` resources in the `ods` namespace.

In the same way, you can install the `tasks` chart via `./install.sh -n ods --chart=tasks --values=values.ods.yaml,secrets.ods.yaml`. You may also use `--dry-run` to see the changes first. This will install the ODS tasks in cluster scope.

Finally, start a build for each created `BuildConfig`.

Now your `ods` namespace is fully setup and users can start to utilize Tekton pipelines for their repositories.

## Updating

You may fetch updates (e.g. new versions) of `ods-pipeline` like this:
```
pipelineGitRef=master
git fetch --depth=1 https://github.com/opendevstack/ods-pipeline.git $pipelineGitRef:ods-pipeline-$pipelineGitRef
git checkout ods-pipeline-$pipelineGitRef
git subtree split --squash --prefix=deploy/central -b subtree-split-branch-$pipelineGitRef
git checkout -
git subtree merge --prefix=ods-pipeline subtree-split-branch-$pipelineGitRef --squash
```
