# User Installation Guide

This guide will show how to install `ods-pipeline` in an existing ODS project. It is possible to use the new Tekton pipelines approach and the classic Jenkins approach side by side.

Note that at the moment, `ods-pipeline` is somewhat compatible with an existing ODS 3.x/4.x installation, but it is not integrated (yet). If `ods-pipeline` gets integrated into OpenDevStack in the future, then the installation guide as presented below may not be needed anymore as the setup process might be automated then. However, the executed steps will likely be similar.

The guide will install the following required resources:

* `ConfigMap` and `Secret` resources, e.g. holding credentials of centrally installed tools such as Nexus and SonarQube
* Tekton Triggers related resources (e.g. `EventListener`, `TriggerTemplate`, etc.) including the ODS webhook interceptor, all of which allow to trigger pipelines in response to Bitbucket webhook requests

## Prerequisites

You'll need:

* A namespace in an OpenShift cluster (such as `foo-cd` from an existing ODS project) and a project in Bitbucket (such as `FOO`)
* `git`, `oc` and `helm` installed locally
* to be logged into OpenShift on the command line

## Instructions

First, create a repository in Bitbucket, e.g. `foo-cd`. The name can be anything, but since the repository will define the resources in namespace `foo-cd` in code, it makes sense to mirror the namespace name. Clone the repository locally and make an initial commit, e.g. by adding a readme file.

Then, use `git subtree` to get the required sources. The following commands may look a bit complicated, but in a nutshell, they are simply adding one folder (`deploy/cd-namespace`) from the `opendestack/ods-pipeline` repository at the given revision (`master`) into your new local repository at the path `ods-pipeline`.

```
pipelineGitRef=master
git fetch --depth=1 https://github.com/opendevstack/ods-pipeline.git $pipelineGitRef:ods-pipeline-$pipelineGitRef
git checkout ods-pipeline-$pipelineGitRef
git subtree split --squash --prefix=deploy/cd-namespace -b subtree-split-branch-$pipelineGitRef
git checkout -
git subtree add --prefix=ods-pipeline subtree-split-branch-$pipelineGitRef
```

Once this is done, change to the new folder `ods-pipeline`. In there, add a `values.foo-cd.yaml` file and fill in the variables. The values expected for those variables are explained in `chart/values.yaml`. The secrets should be stored in a separate file, e.g. `secrets.foo-cd.yaml`. For this, you'll need a GPG keypair, which fingerprint needs to be recorded in `.sops.yaml`, e.g.:

```
creation_rules:
  - pgp: "A2F9 D4AF 800A 5499 3667 5C66 B92D F67B 0EF2 B057"
```

Then you can install the resources via `./install.sh -n foo-cd -f values.foo-cd.yaml,secrets.foo-cd.yaml`. You may also use `--dry-run` to see the changes first.

Finally, run `oc -n foo-cd expose svc el-ods-pipeline` to expose the service listener. Make a note of the exposed URL as you'll need it to create webhooks in Bitbucket.

Now your cd namespace is fully setup and you can start to utilize Tekton pipelines for your repositories. See link:ods-configuration.adoc[ODS configuration] for more information on usage.

## Updating

You may fetch updates (e.g. new versions) of `ods-pipeline` like this:
```
pipelineGitRef=master
git fetch --depth=1 https://github.com/opendevstack/ods-pipeline.git $pipelineGitRef:ods-pipeline-$pipelineGitRef
git checkout ods-pipeline-$pipelineGitRef
git subtree split --squash --prefix=deploy/cd-namespace -b subtree-split-branch-$pipelineGitRef
git checkout -
git subtree merge --prefix=ods-pipeline subtree-split-branch-$pipelineGitRef --squash
```
